<p>status: WIP</p>

<p>At some point, we may need to backfill new columns in a frequently queried table. Assume there are massive amount of
records, and each record has blah blah..</p>

<hr />
<ul id="markdown-toc">
  <li><a href="#generate-backfill-audits" id="markdown-toc-generate-backfill-audits">Generate backfill audits</a></li>
  <li><a href="#daemon-to-run-backfill-tasks" id="markdown-toc-daemon-to-run-backfill-tasks">Daemon to run backfill tasks</a></li>
  <li><a href="#a-general-task" id="markdown-toc-a-general-task">A General Task</a></li>
  <li><a href="#task-list" id="markdown-toc-task-list">Task list</a></li>
  <li><a href="#a-sample-backfill-task" id="markdown-toc-a-sample-backfill-task">A sample backfill task</a></li>
</ul>

<h2 id="generate-backfill-audits">Generate backfill audits</h2>
<p>To maintain durable backfill tasks in the rails application, especially while
backfilling huge loads of records, we’d like to make these audits trackable, and
work on them in a specific order.</p>

<p>For that, we need a table as the following:</p>

<table>
  <thead>
    <tr>
      <th>backfill_audits</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>id</td>
    </tr>
    <tr>
      <td>account_id</td>
    </tr>
    <tr>
      <td>task</td>
    </tr>
    <tr>
      <td>created_at</td>
    </tr>
    <tr>
      <td>started_at</td>
    </tr>
    <tr>
      <td>completed_at</td>
    </tr>
    <tr>
      <td>updated_at</td>
    </tr>
  </tbody>
</table>

<p>The only notable thing here is, on an extreme case when we are backfilling shits during a migration, new record can be
inserted, therefore a re-backfill is needed. For this situation, we put a waterline inside the audits marking a period
to avoid a whole table re-backfilling.</p>

<p>Since this case does not happen constantly, one day gap is good enough (or extend to even longer depending on the amount of records).</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">DurableBackfill</span>
  <span class="k">class</span> <span class="nc">BackfillAudit</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="no">WATERLINE_ACCOUNT_ID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

    <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">"account_id != </span><span class="si">#{</span><span class="no">WATERLINE_ACCOUNT_ID</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">scope</span> <span class="ss">:for_task</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">task: </span><span class="n">task_name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">scope</span> <span class="ss">:incomplete</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">completed_at: </span><span class="kp">nil</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">belongs_to</span> <span class="ss">:account</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">waterline_date</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
      <span class="n">unscoped</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">account_id: </span><span class="no">WATERLINE_ACCOUNT_ID</span><span class="p">,</span> <span class="ss">task: </span><span class="n">task</span><span class="p">).</span><span class="nf">first_or_create</span><span class="p">.</span><span class="nf">created_at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="daemon-to-run-backfill-tasks">Daemon to run backfill tasks</h2>

<p>Before starting the actual backfill task, let’s create backfill audits.
Unless we have fully backfilled the table, backfill task need to run continuously in the background.
Three minutes is not necessarily a good gap, but it is always open to change based on actual circumstances.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'task_list'</span>

<span class="k">module</span> <span class="nn">DurableBackfill</span>
  <span class="k">class</span> <span class="nc">Runner</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">tasks</span>
      <span class="no">DurableBackfill</span><span class="o">::</span><span class="no">Task</span><span class="p">.</span><span class="nf">descendants</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">run</span>
      <span class="n">generate_backfills</span>
      <span class="k">while</span> <span class="kp">true</span> <span class="k">do</span>
        <span class="n">work_backfills</span>
        <span class="nb">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nf">minutes</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">generate_backfills</span>
      <span class="n">tasks</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
        <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">on_all_shards</span> <span class="k">do</span> <span class="o">|</span><span class="n">shard_id</span><span class="o">|</span>
          <span class="n">task</span><span class="p">.</span><span class="nf">create_audits!</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">work_backfills</span>
      <span class="n">tasks</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
        <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">on_all_shards</span> <span class="k">do</span> <span class="o">|</span><span class="n">shard_id</span><span class="o">|</span>
          <span class="n">task</span><span class="p">.</span><span class="nf">audits</span><span class="p">.</span><span class="nf">incomplete</span><span class="p">.</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">audit</span><span class="o">|</span>
            <span class="n">task</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">audit</span><span class="p">).</span><span class="nf">work_audit</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">tasks</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">tasks</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="a-general-task">A General Task</h2>

<p>A waterline account is not a real account, therefore do be aware that its id must not conflict with real account ids.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">DurableBackfill</span>
  <span class="k">class</span> <span class="nc">Task</span>
    <span class="k">class</span> <span class="nc">RescheduleTask</span> <span class="o">&lt;</span> <span class="no">StandardError</span> <span class="p">;</span> <span class="k">end</span>
    <span class="no">WATERLINE_ACCOUNT_ID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="kp">attr_accessor</span> <span class="ss">:title</span>

      <span class="k">def</span> <span class="nf">audits</span>
        <span class="no">DurableBackfill</span><span class="o">::</span><span class="no">BackfillAudit</span><span class="p">.</span><span class="nf">for_task</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">create_audits!</span>
        <span class="n">waterline</span> <span class="o">=</span> <span class="no">DurableBackfill</span><span class="o">::</span><span class="no">BackfillAudit</span><span class="p">.</span><span class="nf">waterline_date</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="no">DurableBackfill</span><span class="o">::</span><span class="no">BackfillAudit</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
          <span class="n">created_accounts</span> <span class="o">=</span> <span class="no">DurableBackfill</span><span class="o">::</span><span class="no">BackfillAudit</span><span class="p">.</span><span class="nf">for_task</span><span class="p">(</span><span class="n">title</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:account_id</span><span class="p">).</span><span class="nf">to_set</span>

          <span class="no">Account</span><span class="p">.</span><span class="nf">shard_local</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="n">waterline</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="s2">"id != </span><span class="si">#{</span><span class="no">Account</span><span class="p">.</span><span class="nf">system_account_id</span><span class="si">}</span><span class="s2">"</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">account</span><span class="o">|</span>
            <span class="k">next</span> <span class="k">if</span> <span class="n">created_accounts</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>

            <span class="no">DurableBackfill</span><span class="o">::</span><span class="no">BackfillAudit</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">task: </span><span class="n">title</span><span class="p">,</span> <span class="ss">account: </span><span class="n">account</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">audit</span><span class="p">)</span>
      <span class="vi">@audit</span> <span class="o">=</span> <span class="n">audit</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
      <span class="k">raise</span> <span class="s2">"must implement work!"</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">work_audit</span>
      <span class="vi">@audit</span><span class="p">.</span><span class="nf">started_at</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
      <span class="k">if</span> <span class="vi">@audit</span><span class="p">.</span><span class="nf">account</span><span class="p">(</span><span class="kp">true</span><span class="p">).</span><span class="nf">shard_local?</span>
        <span class="nb">puts</span> <span class="s2">"work on account</span><span class="si">#{</span><span class="vi">@audit</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">work</span><span class="p">(</span><span class="vi">@audit</span><span class="p">.</span><span class="nf">account</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="vi">@audit</span><span class="p">.</span><span class="nf">completed_at</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
      <span class="vi">@audit</span><span class="p">.</span><span class="nf">save!</span>
    <span class="k">rescue</span> <span class="no">RescheduleTask</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="c1"># leave audit untouched</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">reschedule!</span>
      <span class="k">raise</span> <span class="no">RescheduleTask</span><span class="p">.</span><span class="nf">new</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="task-list">Task list</h2>

<p>We use a tasks folder to keep all actual tasks.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">files</span> <span class="o">=</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"/tasks/*.rb"</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span>  <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">require</span> <span class="n">f</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="a-sample-backfill-task">A sample backfill task</h2>

<p>Now I’d like to backfill the column number_of_employee in table <code class="highlighter-rouge">company</code>.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">DurableBackfill</span>
  <span class="k">class</span> <span class="nc">BackfillNumberOfEmployee</span> <span class="o">&lt;</span> <span class="no">Task</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="s1">'backfill_number_of_employee'</span>

    <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"durable-backfill-number-of-employee-</span><span class="si">#{</span><span class="n">account</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>

      <span class="no">Company</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:account_id</span> <span class="o">=&gt;</span> <span class="n">account</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">update_attribute</span><span class="p">(</span><span class="ss">:number_of_employee</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="nf">count_employee</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
